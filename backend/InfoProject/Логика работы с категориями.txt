╔══════════════════════════════════════════════════════════════════════════════╗
║                  ЛОГИКА РАБОТЫ С КАТЕГОРИЯМИ ОБРАЩЕНИЙ                       ║
╚══════════════════════════════════════════════════════════════════════════════╝

📋 ОБЗОР СИСТЕМЫ
═══════════════════════════════════════════════════════════════════════════════

Система категоризации обращений граждан использует три уровня категорий:

1. CategoryId (int)          - ID категории в базе данных (основное поле)
2. AiCategory (string)       - Категория, определенная нейросетью Gemini
3. FinalCategory (string)    - Финальная категория, подтвержденная сотрудником


🎯 ДОСТУПНЫЕ КАТЕГОРИИ В БАЗЕ ДАННЫХ
═══════════════════════════════════════════════════════════════════════════════

ID  | Название                        | Описание
────┼─────────────────────────────────┼──────────────────────────────────────────
 1  | Имущественные преступления      | Кражи, грабежи, мошенничество
 2  | Транспорт и ПДД                 | ДТП, нарушения ПДД, парковка
 3  | Общественный порядок            | Хулиганство, драки, шум
 4  | Бытовые конфликты               | Семейные ссоры, соседские конфликты
 5  | Угрозы и безопасность           | Угрозы жизни, насилие, вымогательство
 6  | Киберпреступления               | Мошенничество в интернете, взлом
 7  | Наркотики                       | Незаконный оборот наркотиков
 8  | Экология и животные             | Жестокое обращение с животными
 9  | Пропавшие люди                  | Розыск пропавших без вести
10  | Другое                          | Прочие обращения (используется редко)


🔄 ПРОЦЕСС ОБРАБОТКИ КАТЕГОРИЙ
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│ ШАГИ ПРИ СОЗДАНИИ ОБРАЩЕНИЯ (SubmitCitizenRequest)                         │
└─────────────────────────────────────────────────────────────────────────────┘

Шаг 1: Гражданин подает обращение
────────────────────────────────────────────────────────────────────────────────
   ├─ Гражданин ВЫБРАЛ категорию (CategoryId указан)
   │     └─► Сохраняем его выбор в CategoryId
   │
   └─ Гражданин НЕ ВЫБРАЛ категорию (CategoryId = null)
         └─► Устанавливаем CategoryId = 10 ("Другое") как временное


Шаг 2: Обращение сохраняется в БД
────────────────────────────────────────────────────────────────────────────────
   └─► CreatedAt = текущее время
   └─► RequestNumber = уникальный 10-значный номер


Шаг 3: ИИ анализ запускается в фоновом режиме (не блокирует создание)
────────────────────────────────────────────────────────────────────────────────
   ├─► ИИ (Gemini) анализирует описание обращения
   │
   ├─► Заполняются поля AI-анализа:
   │     • AiCategory       - категория от ИИ (строка)
   │     • AiPriority       - приоритет (Высокий/Средний/Низкий)
   │     • AiSummary        - краткое резюме
   │     • AiSentiment      - тональность (Негативный/Нейтральный/Положительный)
   │     • AiSuggestedAction - рекомендуемые действия
   │     • AiAnalyzedAt     - время анализа
   │
   └─► FinalCategory = AiCategory (изначально)


Шаг 4: Обновление CategoryId на основе ИИ анализа
────────────────────────────────────────────────────────────────────────────────
   ├─ ЕСЛИ гражданин НЕ выбирал категорию (CategoryId == 10):
   │     ├─► Ищем категорию в БД по названию от ИИ (AiCategory)
   │     ├─► Если найдена → CategoryId = ID найденной категории
   │     └─► Если не найдена → CategoryId остается 10 ("Другое")
   │
   └─ ЕСЛИ гражданин ВЫБРАЛ категорию:
         └─► CategoryId НЕ меняется (остается выбор гражданина)
         └─► Но AiCategory все равно заполняется (для информации сотруднику)


Шаг 5: Сотрудник просматривает обращение
────────────────────────────────────────────────────────────────────────────────
   Сотрудник видит:
   ├─ CategoryId      - текущая категория (ID)
   ├─ AiCategory      - что предложила ИИ (текст)
   └─ FinalCategory   - финальная категория (текст)


Шаг 6: Сотрудник может изменить категорию (опционально)
────────────────────────────────────────────────────────────────────────────────
   Через API: PATCH /api/CitizenRequests/{id}/correct-category
   
   ├─► FinalCategory обновляется на выбор сотрудника
   ├─► CategoryId обновляется по названию категории
   ├─► IsAiCorrected = true (отмечаем, что была корректировка)
   └─► Логируется в audit_logs для аналитики


📊 ПРИМЕРЫ СЦЕНАРИЕВ
═══════════════════════════════════════════════════════════════════════════════

Сценарий 1: Гражданин НЕ выбрал категорию
────────────────────────────────────────────────────────────────────────────────
1. Гражданин: "У меня украли велосипед"
2. CategoryId = 10 ("Другое") - временно
3. ИИ анализирует → AiCategory = "Имущественные преступления"
4. Система находит категорию в БД → CategoryId = 1
5. FinalCategory = "Имущественные преступления"
6. Результат: CategoryId = 1, AiCategory = "Имущественные преступления"


Сценарий 2: Гражданин ВЫБРАЛ категорию (правильную)
────────────────────────────────────────────────────────────────────────────────
1. Гражданин выбирает "Транспорт и ПДД" → CategoryId = 2
2. Гражданин: "Произошло ДТП на перекрестке"
3. ИИ анализирует → AiCategory = "Транспорт и ПДД"
4. CategoryId НЕ меняется (= 2), так как гражданин выбрал
5. FinalCategory = "Транспорт и ПДД"
6. Результат: Категория совпадает, все корректно


Сценарий 3: Гражданин ВЫБРАЛ категорию (неправильную)
────────────────────────────────────────────────────────────────────────────────
1. Гражданин выбирает "Общественный порядок" → CategoryId = 3
2. Гражданин: "Меня обманули мошенники и украли деньги"
3. ИИ анализирует → AiCategory = "Киберпреступления"
4. CategoryId НЕ меняется (= 3), так как гражданин выбрал
5. FinalCategory = "Киберпреступления" (ИИ предлагает правильную)
6. Сотрудник видит несоответствие:
     - CategoryId = 3 (Общественный порядок)
     - AiCategory = "Киберпреступления"
7. Сотрудник корректирует через API → CategoryId = 6, IsAiCorrected = true
8. Результат: Категория исправлена сотрудником


Сценарий 4: ИИ не может определить категорию
────────────────────────────────────────────────────────────────────────────────
1. Гражданин: "Непонятное сообщение или ошибка ИИ"
2. ИИ возвращает fallback → AiCategory = "Другое"
3. CategoryId остается 10
4. Сотрудник вручную проверяет и меняет категорию при необходимости


📡 API ENDPOINTS
═══════════════════════════════════════════════════════════════════════════════

POST /api/CitizenRequests/submit
   ├─ Создает обращение от гражданина
   ├─ CategoryId опционален (если null → ставится 10)
   └─ Запускает фоновый ИИ анализ

POST /api/CitizenRequests/analyze
   ├─ Анализирует текст обращения через ИИ
   └─ Возвращает GeminiAnalysisResponse

PATCH /api/CitizenRequests/{id}/correct-category
   ├─ Сотрудник корректирует категорию
   ├─ Обновляет FinalCategory, CategoryId, IsAiCorrected
   └─ Логирует в audit_logs

PATCH /api/CitizenRequests/{id}/reclassify
   ├─ Перезапускает ИИ анализ
   └─ Обновляет AI поля (но не меняет CategoryId автоматически)


🔧 ТЕХНИЧЕСКИЕ ДЕТАЛИ
═══════════════════════════════════════════════════════════════════════════════

Модель БД: CitizenRequest
──────────────────────────────────────────────────────────────────────────────
• CategoryId (int, FK)              - ID категории в таблице Categories
• AiCategory (string, 200)          - Название категории от ИИ
• AiPriority (string, 50)           - Приоритет от ИИ
• AiSummary (string, 1000)          - Резюме от ИИ
• AiSuggestedAction (string, 1000)  - Предложенные действия
• AiSentiment (string, 50)          - Тональность
• AiAnalyzedAt (DateTime?)          - Время анализа
• IsAiCorrected (bool)              - Была ли корректировка сотрудником
• FinalCategory (string, 200)       - Финальная категория


Сервис ИИ: GeminiService
──────────────────────────────────────────────────────────────────────────────
• Модель: Gemini 2.5 Flash
• Temperature: 0.3 (низкая для точной классификации)
• Timeout: 30 секунд
• Proxy: http://127.0.0.1:12334 (для обхода блокировок)


🎓 ПРЕИМУЩЕСТВА НОВОЙ СИСТЕМЫ
═══════════════════════════════════════════════════════════════════════════════

✅ Автоматическая категоризация
   └─► ИИ определяет категорию, экономя время сотрудников

✅ Поддержка выбора пользователя
   └─► Если гражданин знает категорию - его выбор сохраняется

✅ Прозрачность
   └─► Сотрудник видит и выбор гражданина, и предложение ИИ

✅ Возможность корректировки
   └─► Сотрудник всегда может исправить категорию

✅ Аудит изменений
   └─► Все корректировки логируются для аналитики

✅ Категория "Другое" используется редко
   └─► Только когда ИИ не может определить или произошла ошибка


📈 АНАЛИТИКА
═══════════════════════════════════════════════════════════════════════════════

Можно отслеживать:
├─ Точность ИИ (IsAiCorrected = false)
├─ Частоту корректировок (IsAiCorrected = true)
├─ Популярные категории (группировка по CategoryId)
└─ Случаи использования "Другое" (CategoryId = 10)


═══════════════════════════════════════════════════════════════════════════════
Файл создан: 07.11.2024
Последнее обновление: 07.11.2024
Разработчик: AI Assistant
═══════════════════════════════════════════════════════════════════════════════

